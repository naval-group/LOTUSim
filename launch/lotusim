#!/bin/bash
# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

ASSETS_PATH="${LOTUSIM_PATH}/assets"
MODEL_PATH="${ASSETS_PATH}/models"
WORLD_PATH="${ASSETS_PATH}/worlds"

# Flags for simulation options
DEBUG="-v0"
GUI="-s"
LOTUSIM_SPDLOG_LEVEL="info"
COMMAND=""
DEFAULT_WORLD="lotusim.world"
WORLD=""

###########
# Functions
###########
print_help() {
    echo -e "${GREEN}Usage:${NC} lotusim [OPTIONS] <command> [arguments]"
    echo -e "${GREEN}Options (can be placed anywhere):${NC}"
    echo -e "  --ws-path PATH          Path to the lotusim workspace (default: $LOTUSIM_WS)"
    echo -e "  --assets-path PATH      Path to the assets directory (default: $ASSETS_PATH)"
    echo -e "  --debug                 Enable debug mode"
    echo -e "  --gui                   Run gz sim GUI (for run command)"
    echo -e "  --help                  Display this help message"
    echo -e ""
    echo -e "${GREEN}Commands:${NC}"
    echo -e "  install                 Install the dependencies"
    echo -e "  clean                   Clean the project"
    echo -e "  build                   Build the project"
    echo -e "  clean_build             Clean and build the project"
    echo -e "  doc                     Generate project documentation"
    echo -e "  ui                      Run the frontend and backend"
    echo -e "  run [world_name]        Run the simulation"
    echo -e ""
    echo -e "${GREEN}Examples:${NC}"
    echo -e "  lotusim run --debug --gui my_world_name"
    echo -e "  lotusim --debug run my_world_name"
    echo -e "  lotusim --ws-path /new/path run --gui"
    echo -e "  lotusim build --debug"
}

parse_all_arguments() {
    local valid_commands=("install" "install_lotus" "install_ui" "clean" "build" "clean_build" "doc" "ui" "run")
    
    while [[ "$#" -gt 0 ]]; do
        case $1 in
        --ws-path)
            if [[ -z "$2" || "$2" == --* ]]; then
                echo -e "${RED}Error:${NC} --ws-path requires a path argument"
                exit 1
            fi
            LOTUSIM_WS="$2"
            shift 2
            ;;
        --assets-path)
            if [[ -z "$2" || "$2" == --* ]]; then
                echo -e "${RED}Error:${NC} --assets-path requires a path argument"
                exit 1
            fi
            ASSETS_PATH="$2"
            MODEL_PATH="${ASSETS_PATH}/models"
            WORLD_PATH="${ASSETS_PATH}/worlds"
            shift 2
            ;;
        --debug)
            DEBUG="-v4"
            LOTUSIM_SPDLOG_LEVEL="debug"
            shift
            ;;
        --gui)
            GUI=""
            shift
            ;;
        --help)
            print_help
            exit 0
            ;;
        --*)
            echo -e "${RED}Error:${NC} Unknown option: $1"
            print_help
            exit 1
            ;;
        *)
            # Check if this is a valid command
            if [[ " ${valid_commands[@]} " =~ " $1 " ]]; then
                if [[ -n "$COMMAND" ]]; then
                    echo -e "${RED}Error:${NC} Multiple commands detected: '$COMMAND' and '$1'"
                    echo -e "Please specify only one command."
                    print_help
                    exit 1
                fi
                COMMAND="$1"
                shift
             else
                # This is a positional argument (world file)
                if [[ "$1" == *.world ]]; then
                    if [[ -n "$WORLD" ]]; then
                        echo -e "${RED}Error:${NC} Multiple world files specified: '$WORLD' and '$1'"
                        echo -e "Please specify only one world file."
                        exit 1
                    fi
                    WORLD="$1"
                else
                    echo -e "${RED}Error:${NC} Unexpected argument: $1"
                    echo -e "World files must have .world extension (e.g., my_world.world)"
                    print_help
                    exit 1
                fi
                shift
            fi
            ;;
        esac
    done
    
    # Validate that a command was provided
    if [[ -z "$COMMAND" ]]; then
        echo -e "${RED}Error:${NC} No command provided."
        print_help
        exit 1
    fi
}

install_lotus_dep() {

    echo -e "
********************************************************************************************
*******************************    ${GREEN}Installing Lotusim${NC}    ***********************************
********************************************************************************************
    "
    if [ "$EUID" -ne 0 ]; then
        sudo -E "$LOTUSIM_PATH/launch/install_dep.sh"
    else
        "$LOTUSIM_PATH/launch/install_dep.sh"
    fi
}

install_ui() {
    echo -e "
********************************************************************************************
******************************    ${GREEN}Installing Lotusim UI${NC}    **********************************
********************************************************************************************
    "
    echo -e "\nðŸ”„ Sourcing ROS workspace setup..."
    source "${LOTUSIM_WS}/install/setup.bash"

    echo -e "\nâ¬‡ï¸  Installing NVM..."
    curl -s -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash >/dev/null

    echo -e "\nðŸ“¦ Loading NVM into current shell..."
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

    echo -e "\nðŸ“¦ Installing Node.js v18 with NVM..."
    nvm install 18 >/dev/null
    nvm use 18 >/dev/null

    echo -e "
********************************************************************************************
*******************************    ${GREEN}Installing UI backend${NC}   *********************************
********************************************************************************************
    "

    BACKEND_DIR="${LOTUSIM_WS}/src/lotusim_backend"
    if [ -d "$BACKEND_DIR" ]; then
        echo -e "\nðŸ“¦ Installing backend dependencies..."
        npm install --silent --prefix "$BACKEND_DIR" >/dev/null 2>&1 || {
            echo -e "${RED}âŒ Error:${NC} Backend dependencies installation failed."
            return 1
        }

        echo -e "\nâš™ï¸  Generating ROS messages for backend..."
        npx --prefix "$BACKEND_DIR" generate-ros-messages >/dev/null 2>&1 || {
            echo -e "${RED}âŒ Error:${NC} ROS message generation failed."
            return 1
        }
        
        echo -e "${GREEN}âœ… Backend installation successful!${NC}"

    else
        echo -e "\nâš ï¸  Backend directory not found: $BACKEND_DIR â€” skipping backend installation."
    fi

    echo -e "
********************************************************************************************
*******************************    ${GREEN}Installing UI frontend${NC}  *********************************
********************************************************************************************
    "

    FRONTEND_DIR="${LOTUSIM_WS}/src/lotusim_ui"
    if [ -d "$FRONTEND_DIR" ]; then
        echo -e "\nðŸ“¦ Installing frontend dependencies..."
        npm install --silent --prefix "$FRONTEND_DIR" >/dev/null 2>&1 || {
            echo -e "${RED}âŒ Error:${NC} Frontend dependencies installation failed."
            return 1
        }
        
        echo -e "${GREEN}âœ… Frontend installation successful!${NC}"    
    else
        echo -e "\nâš ï¸  Frontend directory not found: $FRONTEND_DIR â€” skipping frontend installation."
    fi

    echo -e "
********************************************************************************************
**************************    ${GREEN}âœ… UI installation complete!${NC}    *******************************
********************************************************************************************
    "
}

build_lotus() {
    echo -e "
********************************************************************************************
********************************    ${GREEN}Building Lotusim${NC}    ************************************
********************************************************************************************
    "
    source "/opt/ros/humble/setup.bash"
    cd ${LOTUSIM_WS}
    if [ "$DEBUG" == "-v4" ]; then
        echo -e "${GREEN}Debug mode enabled: Printing out debug logs. Enabling LOTUSIM_TIDY"
        colcon build --cmake-args -DLOTUSIM_TIDY=ON -DDEBUG=ON --symlink-install --merge-install || {
            echo -e "${RED}Error:${NC} Build failed."
            exit 1
        }
    else
        colcon --log-level 50 build --merge-install --event-handlers compile_commands+ console_cohesion- console_direct- console_package_list- console_start_end- console_stderr+ \
        desktop_notification- event_log+ log+ log_command+ status+ store_result- summary+ terminal_title- || {
            echo -e "${RED}Error:${NC} Build failed."
            exit 1
        }
    fi
    echo -e "
********************************************************************************************
**************************    ${GREEN}âœ… Lotusim build successful!${NC}    ****************************
********************************************************************************************
    "
}

validate_lotusim_core_setup() {
    if [ ! -f "/opt/ros/humble/setup.bash" ]; then
        echo -e "${RED}Error:${NC} ROS2 Humble is not installed or the setup.bash is not found at /opt/ros/humble/setup.bash."
        exit 1
    fi
    if [ ! -d "${LOTUSIM_WS}" ]; then
        echo -e "${RED}Error:${NC} The lotusim workspace does not exist at $LOTUSIM_WS."
        exit 1
    fi
    if [ ! -d "${LOTUSIM_PATH}" ]; then
        echo -e "${RED}Error:${NC} The lotusim repo does not exist at $LOTUSIM_PATH."
        exit 1
    fi
}

validate_ui_setup() {
    local errors=0
    # Check if nvm is available
    if ! command -v nvm &> /dev/null; then
        # nvm is a shell function, try to source it
        if [ -f "$HOME/.nvm/nvm.sh" ]; then
            source "$HOME/.nvm/nvm.sh"
        else
            echo -e "âŒ ${RED}Error:${NC} nvm is not installed or not found"
            errors=$((errors + 1))
        fi
    fi
    
    # Check if Node.js 18 is available via nvm
    if command -v nvm &> /dev/null || type nvm &> /dev/null; then
        if ! nvm ls 18 &> /dev/null; then
            echo -e "âŒ ${RED}Error:${NC} Node.js version 18 is not installed via nvm"
            echo -e "   Install with: nvm install 18"
            errors=$((errors + 1))
        fi
    fi
    
    # Check backend directory
    BACKEND_DIR="${LOTUSIM_WS}/src/lotusim_backend"
    if [ ! -d "$BACKEND_DIR" ]; then
        echo -e "${RED}Error:${NC} Backend directory not found: $BACKEND_DIR"
        errors=$((errors + 1))
    fi
    
    # Check frontend directory
    FRONTEND_DIR="${LOTUSIM_WS}/src/lotusim_ui"
    if [ ! -d "$FRONTEND_DIR" ]; then
        echo -e "${RED}Error:${NC}: Frontend directory not found: $FRONTEND_DIR"
        errors=$((errors + 1))
    fi

    if [ $errors -gt 0 ]; then
        exit 1
    fi
}


source_environment() {
    source "/opt/ros/humble/setup.bash"
    source "${LOTUSIM_WS}/install/setup.bash"

    export GZ_SIM_SYSTEM_PLUGIN_PATH="${LOTUSIM_WS}/install/lib"
    export GZ_GUI_PLUGIN_PATH="${LOTUSIM_WS}/install/lib"
    export GZ_SIM_RESOURCE_PATH="${MODEL_PATH}"
    export LOTUSIM_SPDLOG_LEVEL="${LOTUSIM_SPDLOG_LEVEL}"

    echo -e "${GREEN}GZ_SIM_SYSTEM_PLUGIN_PATH${NC}: $GZ_SIM_SYSTEM_PLUGIN_PATH"
    echo -e "${GREEN}GZ_SIM_RESOURCE_PATH${NC}: $GZ_SIM_RESOURCE_PATH"
    echo -e "${YELLOW}LOTUSIM_SPDLOG_LEVEL${NC}: $LOTUSIM_SPDLOG_LEVEL"

}

run_command() {
    case $COMMAND in
    install)
        install_lotus_dep
        validate_lotusim_core_setup
        build_lotus
        install_ui
        ;;
    install_lotus)
        install_lotus_dep
        validate_lotusim_core_setup
        build_lotus
        ;;
    install_ui)
        install_lotus_dep
        validate_lotusim_core_setup
        install_ui
        ;;
    clean)
        rm -rf "${LOTUSIM_WS}/log" "${LOTUSIM_WS}/install" "${LOTUSIM_WS}/build"
        echo -e "${GREEN}Clean complete.${NC}"
        ;;
    build)
        clear
        validate_lotusim_core_setup
        build_lotus
        ;;
    clean_build)
        clear
        echo -e "Cleaning and building the project..."
        rm -rf "${LOTUSIM_WS}/log" "${LOTUSIM_WS}/install" "${LOTUSIM_WS}/build"
        build_lotus
        ;;
    doc)
        cd "${LOTUSIM_PATH}/docs" || {
            echo -e "${RED}Error:${NC} Failed to change directory to docs."
            exit 1
        }
        doxygen Doxyfile || {
            echo -e "${RED}Error:${NC} Documentation generation failed."
            exit 1
        }
        echo -e "Docs generated at ${LOTUSIM_PATH}/docs"
        ;;
    run)
        clear
        validate_lotusim_core_setup
        source_environment

        # Use provided world or default
        local world_file="${WORLD:-$DEFAULT_WORLD}"

        echo -e "${GREEN}Running the simulation world${NC}: ${WORLD_PATH}/${world_file}"
        gz sim ${DEBUG} ${GUI} -r "${WORLD_PATH}/${world_file}"
        ;;
    ui)
        clear
        validate_lotusim_core_setup
        source_environment
        validate_ui_setup

        cleanup() {
        echo -e "${GREEN}Shutting down${NC} backend and frontend..."
        kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
        wait $BACKEND_PID $FRONTEND_PID 2>/dev/null
        exit
        }

        # Set up trap to catch signals
        trap cleanup SIGINT SIGTERM EXIT

        # Start backend
        cd ${LOTUSIM_WS}/src/lotusim_backend
        npx ts-node src/main.ts &
        BACKEND_PID=$!

        # Start frontend
        cd ${LOTUSIM_WS}/src/lotusim_ui
        npm run dev &
        FRONTEND_PID=$!

        echo -e "${GREEN}Backend PID:${NC} $BACKEND_PID"
        echo -e "${GREEN}Frontend PID:${NC} $FRONTEND_PID"
        echo -e "Press ${GREEN}Ctrl+C${NC} to stop both processes"

        # Wait for both processes
        wait $BACKEND_PID $FRONTEND_PID
        ;;
    *)
        echo -e "${RED}Error:${NC} Unknown command: $COMMAND"
        print_help
        exit 1
        ;;
    esac
}

#######
# Main
#######
export GZ_VERSION=harmonic

# Check if no arguments provided
if [ $# -eq 0 ]; then
    echo -e "${RED}Error:${NC} No command provided."
    print_help
    exit 1
fi

# Parse all arguments in one pass
parse_all_arguments "$@"

# Execute the command
run_command